<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Azure Cloud Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="navbar">
    <div class="brand">
      <span class="brand-dot"></span>
      Azure Cloud Dashboard
    </div>
    <a class="nav-link" href="/logout">Logout</a>
  </div>

  <div class="container">
    <div id="toast" class="toast"></div>

    <!-- KPI -->
    <div class="kpis">
      <div class="kpi"><div class="t">TOTAL VMs</div><div class="v" id="k_total">-</div></div>
      <div class="kpi"><div class="t">RUNNING</div><div class="v" id="k_running">-</div></div>
      <div class="kpi"><div class="t">STOPPED</div><div class="v" id="k_stopped">-</div></div>
      <div class="kpi"><div class="t">OTHER</div><div class="v" id="k_other">-</div></div>
    </div>

    <div class="card">
      <div class="header-row">
        <div>
          <h2 class="h-title">Virtual Machines</h2>
          
        </div>

        <div class="controls">
          <input id="searchBox" class="input" style="min-width:240px;" type="text"
                 placeholder="Search VM / Resource Group..." oninput="renderTable()" />

          <select id="statusFilter" class="select" onchange="renderTable()">
            <option value="all">All status</option>
            <option value="running">Running</option>
            <option value="stopped">Stopped</option>
            <option value="deallocated">Deallocated</option>
            <option value="unknown">Unknown</option>
          </select>

          <select id="sortBy" class="select" onchange="renderTable()">
            <option value="name">Sort: Name</option>
            <option value="status">Sort: Status</option>
            <option value="resource_group">Sort: Resource Group</option>
          </select>

          <button class="btn-sm btn-refresh" onclick="refreshAll()">Refresh</button>
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th style="width:30%;">VM Name</th>
            <th style="width:28%;">Resource Group</th>
            <th style="width:18%;">Status</th>
            <th style="width:24%;">Actions</th>
          </tr>
        </thead>
        <tbody id="vmTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBg" class="modal-bg" onclick="hideModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">VM Details</div>
        <button class="close-btn" onclick="hideModal()">✕</button>
      </div>

      <div class="grid">
        <div class="box"><div class="b-label">VM Name</div><div class="b-val" id="d_name">-</div></div>
        <div class="box"><div class="b-label">Resource Group</div><div class="b-val" id="d_rg">-</div></div>
        <div class="box"><div class="b-label">Location</div><div class="b-val" id="d_loc">-</div></div>
        <div class="box"><div class="b-label">VM Size</div><div class="b-val" id="d_size">-</div></div>
        <div class="box"><div class="b-label">OS Type</div><div class="b-val" id="d_os">-</div></div>
        <div class="box"><div class="b-label">Power State</div><div class="b-val" id="d_state">-</div></div>
      </div>

      <div class="modal-actions">
        <button class="m-btn m-start" onclick="modalAction('start')">Start</button>
        <button class="m-btn m-restart" onclick="modalAction('restart')">Restart</button>
        <button class="m-btn m-stop" onclick="modalAction('stop')">Stop</button>
        <button class="m-btn m-delete" onclick="modalDelete()">Delete</button>
      </div>

      <div class="helper">Azure operations take time — status updates after refresh.</div>
    </div>
  </div>

<script>
let ALL_VMS = [];
let busyKey = null;
let selectedRG = null;
let selectedVM = null;

function toast(text, type){
  const t = document.getElementById("toast");
  t.className = `toast ${type}`;
  t.innerText = text;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", 3200);
}

function chip(status){
  const s = (status || "unknown");
  return `<span class="chip ${s}"><span class="dot"></span>${s}</span>`;
}

async function refreshKPIs(){
  try{
    const res = await fetch("/api/vm/status-count");
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "Failed to load counts");

    document.getElementById("k_total").innerText = data.total ?? "-";
    document.getElementById("k_running").innerText = data.running ?? "-";
    document.getElementById("k_stopped").innerText = data.stopped ?? "-";
    document.getElementById("k_other").innerText = data.other ?? "-";
  }catch(err){
    toast(err.message, "error");
  }
}

async function loadVMs(){
  try{
    const res = await fetch("/api/vms");
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "Failed to load VMs");
    ALL_VMS = Array.isArray(data) ? data : [];
    renderTable();
  }catch(err){
    toast(err.message, "error");
  }
}

function renderTable(){
  const tbody = document.getElementById("vmTable");
  tbody.innerHTML = "";

  const q = document.getElementById("searchBox").value.trim().toLowerCase();
  const filter = document.getElementById("statusFilter").value;
  const sortBy = document.getElementById("sortBy").value;

  let vms = [...ALL_VMS];

  if(q){
    vms = vms.filter(vm =>
      (vm.name||"").toLowerCase().includes(q) ||
      (vm.resource_group||"").toLowerCase().includes(q)
    );
  }
  if(filter !== "all"){
    vms = vms.filter(vm => (vm.status || "unknown") === filter);
  }
  vms.sort((a,b)=>{
    const A = (a[sortBy] || "").toString().toLowerCase();
    const B = (b[sortBy] || "").toString().toLowerCase();
    return A.localeCompare(B);
  });

  vms.forEach(vm=>{
    const key = `${vm.resource_group}:${vm.name}`;
    const disabled = (busyKey === key);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="vm-link" onclick="openDetails('${vm.resource_group}','${vm.name}')">${vm.name}</span></td>
      <td>${vm.resource_group}</td>
      <td>${chip(vm.status)}</td>
      <td>
        <div class="actions">
          <button class="a-btn a-start" ${disabled?"disabled":""} onclick="vmAction('start','${vm.resource_group}','${vm.name}')">Start</button>
          <button class="a-btn a-restart" ${disabled?"disabled":""} onclick="vmAction('restart','${vm.resource_group}','${vm.name}')">Restart</button>
          <button class="a-btn a-stop" ${disabled?"disabled":""} onclick="vmAction('stop','${vm.resource_group}','${vm.name}')">Stop</button>
          <button class="a-btn a-delete" ${disabled?"disabled":""} onclick="deleteVM('${vm.resource_group}','${vm.name}')">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function vmAction(action, rg, name){
  const key = `${rg}:${name}`;
  busyKey = key;
  renderTable();

  try{
    const res = await fetch(`/api/vm/${action}`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ resource_group: rg, vm_name: name })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "Action failed");

    toast(data.message, "success");
    setTimeout(refreshAll, 2500);
  }catch(err){
    toast(err.message, "error");
  }finally{
    busyKey = null;
    renderTable();
  }
}

async function deleteVM(rg, name){
  const ok = confirm(`Are you sure you want to DELETE VM: ${name}?`);
  if(!ok) return;
  vmAction("delete", rg, name);
}

/* Modal */
function showModal(){ document.getElementById("modalBg").style.display="flex"; }
function hideModal(){ document.getElementById("modalBg").style.display="none"; }
function setD(id,val){ document.getElementById(id).innerText = (val ?? "-"); }

async function openDetails(rg, name){
  selectedRG = rg;
  selectedVM = name;

  document.getElementById("modalTitle").innerText = `VM Details: ${name}`;
  setD("d_name", name);
  setD("d_rg", rg);
  setD("d_loc", "Loading...");
  setD("d_size", "Loading...");
  setD("d_os", "Loading...");
  setD("d_state", "Loading...");
  showModal();

  try{
    const res = await fetch(`/api/vm/details?resource_group=${encodeURIComponent(rg)}&vm_name=${encodeURIComponent(name)}`);
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || "Failed to load details");

    setD("d_name", data.name);
    setD("d_rg", data.resource_group);
    setD("d_loc", data.location);
    setD("d_size", data.vm_size);
    setD("d_os", data.os_type);
    setD("d_state", data.power_state);
  }catch(err){
    toast(err.message, "error");
    setD("d_loc","-"); setD("d_size","-"); setD("d_os","-"); setD("d_state","-");
  }
}

async function modalAction(action){
  if(!selectedRG || !selectedVM) return;
  await vmAction(action, selectedRG, selectedVM);
  setTimeout(()=> openDetails(selectedRG, selectedVM), 2000);
}

async function modalDelete(){
  if(!selectedRG || !selectedVM) return;
  const ok = confirm(`Are you sure you want to DELETE VM: ${selectedVM}?`);
  if(!ok) return;
  await vmAction("delete", selectedRG, selectedVM);
  hideModal();
}

async function refreshAll(){
  await Promise.all([refreshKPIs(), loadVMs()]);
}

refreshAll();
setInterval(refreshAll, 20000);
</script>

</body>
</html>
